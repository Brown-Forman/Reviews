---
title: "Tripadvisor"
author: "Thi Allgood"
date: "3/23/2020"
output: html_document
---

```{r}
library(rvest)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(tm)
library(scales)
library(topicmodels)
library(rvest)
library(purrr)
library(rvest)
library(stringr)
library(rvest)
```

```{r}

func_body <- function(body,responded.yn){
  response = rep(NA,10)
  content = rep(NA,10)
  n = length(responded.yn)
  i = 1
  a = 1
  while (a < n){
    if (responded.yn[a] == FALSE & responded.yn[a+1] == TRUE){
      content[i] = body[a]
      response[i] = body[a+1]
      i = i + 1
      a = a + 2
    } else {
      content[i] = body[a]
      response[i] = NA
      i = i + 1
      a = a + 1
    }
  }
  if (responded.yn[n] == FALSE){
    content[10] = body[n]
    response[10] = NA
  }
  df = data.frame(content,response) %>%
    mutate(content = as.character(content),
           response = as.character(response))
  return(df)
    }


```


```{r}
# Read the web page and get the number of reviews
mussel.n.burger <- read_html("https://www.tripadvisor.com/Restaurant_Review-g39604-d9799396-Reviews-Mussel_Burger_Bar_Downtown-Louisville_Kentucky.html")

# find the the lnumber of the last page listed in the bottom of the main page
npages<-mussel.n.burger%>% 
        html_nodes(" .pageNum ") %>% 
        html_attr(name="data-page-number") %>%
        tail(.,1) %>%
        as.numeric()

totalReviews <- mussel.n.burger %>%
  html_nodes("a.restaurants-detail-overview-cards-RatingsOverviewCard__ratingCount--DFxkG") %>%
  html_text()
totalReviews <- strsplit(totalReviews, " ")[[1]][1]
totalReviews <- as.numeric(gsub(",", "", totalReviews))

headline <- mussel.n.burger %>%
  html_nodes("span.noQuotes") %>%
  html_text()

body <- mussel.n.burger %>%
  html_nodes("p.partial_entry") %>%
  html_text()

responded.yn <- mussel.n.burger %>%
    html_nodes("div.mgrRspnInline") %>%
    html_text()
responded.yn <-strsplit(responded.yn,'Responded ')
responded.yn <- sapply(responded.yn,function(x) x[2])
# tripadvisor was founded in 2000 so this shoud captured all the reviews '20..'
responded.yn <- str_replace_all(responded.yn,'20..','qwertyuiop') 
responded.yn <- str_split(responded.yn,'qwertyuiop')
responded.yn <- sapply(responded.yn,function(x) x[2])
responded.yn <- body %in% responded.yn

df <- func_body(body,responded.yn)
response <- df$response
content <- df$content

star <- mussel.n.burger %>%
  html_nodes("span.ui_bubble_rating") %>%
  html_attr("alt") 
star <- star[!is.na(star)]
star <- star[3:length(star)]
star <- strsplit(star, " ")
star <- as.numeric(lapply(star, `[[`, 1))

l_headline = length(headline)
length_df1 = data.frame(l_headline)

n = 10
for (o in 1:(npages-1)){
  n.character = as.character(n)
  url = paste0("https://www.tripadvisor.com/Restaurant_Review-g39604-d9799396-Reviews",
               '-or',n.character,"-Mussel_Burger_Bar_Downtown-Louisville_Kentucky.html")
  reviews = read_html(url)
  
  headline.temp = reviews %>%
    html_nodes("span.noQuotes") %>%
    html_text()
  headline = append(headline,headline.temp)
  
  # body including reviews and response from owner, need to look at responded.yn.temp to distinguish between review and response
  body.temp <- reviews %>%
  html_nodes(".entry .partial_entry") %>%
  html_text()
  
  # Owner responded yes or no
  responded.yn.temp <- reviews %>%
    html_nodes("div.mgrRspnInline") %>%
    html_text()
  responded.yn.temp <- strsplit(responded.yn.temp,"Responded ")
  responded.yn.temp <- sapply(responded.yn.temp,function(x) x[2])
  responded.yn.temp <- str_replace_all(responded.yn.temp,', 20..',"qwertyuiop")
  responded.yn.temp <- strsplit(responded.yn.temp,'qwertyuiop')
  responded.yn.temp <- sapply(responded.yn.temp,function(x) x[2])
  responded.yn.temp <- body.temp %in% responded.yn.temp 
  
  df.temp <- func_body(body.temp,responded.yn.temp)
 
  content.temp = df.temp$content
  content = append(content,content.temp)
  
  response.temp = df.temp$response
  response = append(response,response.temp)
  
  star.temp <- reviews %>%
    html_nodes("span.ui_bubble_rating") %>%
    html_attr("alt") 
  star.temp <- star.temp[!is.na(star.temp)]
  star.temp <- star.temp[3:length(star.temp)]
  star.temp <- strsplit(star.temp, " ")
  star.temp <- as.numeric(lapply(star.temp, `[[`, 1))
  star <- append(star,star.temp)
  n = n + 10
  print(o)
  l_headline = length(headline.temp)
  print(l_headline)
  
  length_df.temp = data.frame(l_headline)
  length_df1 = rbind(length_df1,length_df.temp)
}

df <- data.frame(content)
  
```

